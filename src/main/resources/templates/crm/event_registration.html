<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이벤트 등록 - 힝거 피부과</title>
    
    <!-- CSS 파일들 -->
    <link rel="stylesheet" href="/crm/css/company_sidebar.css">
    <link rel="stylesheet" href="/crm/css/company_header.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* 기본 리셋 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            background-color: #f8f9fa !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            min-height: 100vh !important;
        }
        
        /* 메인 컨테이너 */
        .dashboard-container {
            display: flex !important;
            min-height: 100vh !important;
            background-color: #f8f9fa !important;
        }
        
        /* 메인 콘텐츠 영역 */
        .main-content {
            flex: 1 !important;
            background-color: #f8f9fa !important;
            min-height: 100vh !important;
            margin-left: 250px !important;
        }
        
        /* 메인 콘텐츠 */
        .event-main-content {
            padding: 0 30px 30px 30px !important;
        }
        
        .event-page-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 30px !important;
        }
        
        .event-page-title {
            font-size: 28px !important;
            font-weight: bold !important;
            color: #2c3e50 !important;
        }
        
        .event-approval-btn {
            background: #3498db !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: background-color 0.3s !important;
        }
        
        .event-approval-btn:hover {
            background: #2980b9 !important;
        }
        
        /* 폼 섹션 */
        .event-form-section {
            background: white !important;
            border-radius: 12px !important;
            padding: 30px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
        }
        
        .event-section-title {
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #2c3e50 !important;
            margin-bottom: 20px !important;
            padding-bottom: 10px !important;
            border-bottom: 2px solid #3498db !important;
        }
        
        .event-form-group {
            margin-bottom: 25px !important;
        }
        
        .event-form-label {
            display: block !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            color: #2c3e50 !important;
            margin-bottom: 8px !important;
        }
        
        .event-form-input {
            width: 100% !important;
            padding: 12px 15px !important;
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            transition: border-color 0.3s !important;
        }
        
        .event-form-input:focus {
            outline: none !important;
            border-color: #3498db !important;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2) !important;
        }
        
        .event-form-textarea {
            width: 100% !important;
            padding: 12px 15px !important;
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            resize: vertical !important;
            min-height: 100px !important;
            transition: border-color 0.3s !important;
        }
        
        .event-form-textarea:focus {
            outline: none !important;
            border-color: #3498db !important;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2) !important;
        }
        
        .event-form-note {
            font-size: 12px !important;
            color: #7f8c8d !important;
            margin-top: 5px !important;
        }
        
        .event-char-counter {
            font-size: 12px !important;
            color: #7f8c8d !important;
            text-align: right !important;
            margin-top: 5px !important;
        }
        
        /* 날짜 입력 */
        .event-date-group {
            display: flex !important;
            gap: 20px !important;
            align-items: center !important;
        }
        
        .event-date-input {
            position: relative !important;
            flex: 1 !important;
        }
        
        .event-date-input input {
            padding-right: 40px !important;
        }
        
        .event-date-icon {
            position: absolute !important;
            right: 12px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            color: #7f8c8d !important;
            pointer-events: none !important;
        }
        
        .event-checkbox-group {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        
        .event-checkbox {
            width: 16px !important;
            height: 16px !important;
        }
        
        .event-checkbox-label {
            font-size: 14px !important;
            color: #2c3e50 !important;
            margin: 0 !important;
        }
        
        /* 라디오 버튼 그룹 */
        .event-radio-group {
            display: flex !important;
            gap: 20px !important;
            flex-wrap: wrap !important;
        }
        
        .event-radio-item {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        
        .event-radio {
            width: 16px !important;
            height: 16px !important;
        }
        
        .event-radio-label {
            font-size: 14px !important;
            color: #2c3e50 !important;
            margin: 0 !important;
        }
        
        /* 태그 입력 */
        .event-tags-container {
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            padding: 10px !important;
            min-height: 50px !important;
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            align-items: center !important;
        }
        
        .event-tag {
            background: #e9ecef !important;
            color: #495057 !important;
            padding: 4px 8px !important;
            border-radius: 12px !important;
            font-size: 12px !important;
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
        }
        
        .event-tag-remove {
            background: none !important;
            border: none !important;
            color: #6c757d !important;
            cursor: pointer !important;
            font-size: 12px !important;
            padding: 0 !important;
            width: 16px !important;
            height: 16px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .event-tag-input {
            border: none !important;
            outline: none !important;
            flex: 1 !important;
            min-width: 100px !important;
            padding: 4px !important;
            font-size: 14px !important;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .event-date-group {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            .event-radio-group {
                flex-direction: column !important;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 사이드바 -->
        <div th:replace="common/company_sidebar :: company_sidebar"></div>
        
        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <!-- 헤더 -->
            <div th:replace="common/company_header :: company_header"></div>
        
        <script>
            // 이벤트 등록 페이지에서 사이드바 활성 상태 설정
            document.addEventListener('DOMContentLoaded', function() {
                // 모든 nav-link에서 active 클래스 제거
                const allNavLinks = document.querySelectorAll('.nav-link');
                allNavLinks.forEach(link => link.classList.remove('active'));
                
                // 의료 서비스 관리 링크에 active 클래스 추가
                const medicalServiceLink = document.querySelector('a[href="/company/medical-services"]');
                if (medicalServiceLink) {
                    medicalServiceLink.classList.add('active');
                }
            });
        </script>
        
            <!-- 메인 콘텐츠 -->
            <div class="event-main-content">
                <div class="event-page-header">
                    <h2 class="event-page-title">의료 서비스 등록</h2>
                    <button class="event-approval-btn">서비스 등록</button>
                </div>
                
                <!-- 의료 서비스 등록 폼 -->
                <form id="medicalServiceForm" action="/api/medical-services/item/1" method="POST">
                    <!-- 이벤트 정보 섹션 -->
                    <div class="event-form-section">
                        <h3 class="event-section-title">서비스 정보</h3>
                        
                        <!-- 이벤트 제목 -->
                        <div class="event-form-group">
                            <label class="event-form-label">서비스 제목</label>
                            <input type="text" name="name" class="event-form-input" placeholder="예: 사각턱보톡스 리즈톡스 50유닛 / 자연유착 쌍꺼풀" maxlength="100" required>
                            <div class="event-form-note">비용을 입력하지 마세요. & - , . _ 를 제외한 다른 특수문자는 입력하지 마세요.</div>
                            <div class="event-char-counter">0 / 100</div>
                        </div>
                    
                    <!-- 이벤트 기간 -->
                    <div class="event-form-group">
                        <label class="event-form-label">서비스 기간</label>
                        <div class="event-date-group">
                            <div class="event-date-input">
                                <input type="date" name="startDate" class="event-form-input">
                                <i class="fas fa-calendar event-date-icon"></i>
                            </div>
                            <span>~</span>
                            <div class="event-date-input">
                                <input type="date" name="endDate" class="event-form-input">
                                <i class="fas fa-calendar event-date-icon"></i>
                            </div>
                            <div class="event-checkbox-group">
                                <input type="checkbox" class="event-checkbox" id="businessEndDate">
                                <label for="businessEndDate" class="event-checkbox-label">업종료일 설정</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 대상 성별 -->
                    <div class="event-form-group">
                        <label class="event-form-label">대상 성별</label>
                        <div class="event-radio-group">
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="targetGender" value="unisex" checked>
                                <label class="event-radio-label">남녀공용</label>
                            </div>
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="targetGender" value="female">
                                <label class="event-radio-label">여성</label>
                            </div>
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="targetGender" value="male">
                                <label class="event-radio-label">남성</label>
                            </div>
                        </div>
                    </div>
                    
                        <!-- 자유 태그 -->
                        <div class="event-form-group">
                            <label class="event-form-label">자유 태그</label>
                            <div class="event-tags-container" id="freeTagsContainer">
                                <input type="text" class="event-tag-input" placeholder="단어를 입력하고 엔터키를 누르세요" id="freeTagInput">
                            </div>
                            <input type="hidden" name="tags" id="tagsInput">
                            <div class="event-form-note">단어를 입력하시고 엔터키를 누르시면 자유 태그로 등록됩니다. 최대 5개까지 입력 가능합니다. 의료 서비스와 관련 없는 태그는 통보 없이 삭제될 수 있습니다.</div>
                        </div>
                    </div>
                
                <!-- 이벤트 분류 섹션 -->
                <div class="event-form-section">
                    <h3 class="event-section-title">서비스 분류</h3>
                    
                        <!-- 대상 국가 -->
                        <div class="event-form-group">
                            <label class="event-form-label">대상 국가</label>
                            <div class="event-radio-group">
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="targetCountry" value="KOR" checked>
                                    <label class="event-radio-label">한국 (한국어)</label>
                                </div>
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="targetCountry" value="JPN">
                                    <label class="event-radio-label">일본 (일본어)</label>
                                </div>
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="targetCountry" value="OTHER">
                                    <label class="event-radio-label">그 외 국가 (영어)</label>
                                </div>
                            </div>
                        </div>
                    
                        <!-- 시술명 태그 -->
                        <div class="event-form-group">
                            <label class="event-form-label">시술명 태그</label>
                            <div class="event-tags-container" id="procedureTagsContainer">
                                <div class="event-tag">
                                    <span>지방분해주사</span>
                                    <button class="event-tag-remove" onclick="removeTag(this)">×</button>
                                </div>
                                <div class="event-tag">
                                    <span>지방흡입주사</span>
                                    <button class="event-tag-remove" onclick="removeTag(this)">×</button>
                                </div>
                                <input type="text" class="event-tag-input" placeholder="시술명을 입력하고 엔터키를 누르세요" id="procedureTagInput">
                            </div>
                            <input type="hidden" name="serviceCategory" id="serviceCategoryInput">
                            <div class="event-form-note">최대 8개까지 선택할 수 있어요. 의료 서비스와 관련 없는 태그는 통보 없이 삭제될 수 있어요.</div>
                            <ul style="margin-top: 10px; padding-left: 20px; font-size: 12px; color: #7f8c8d;">
                                <li>앱 결제 기능이 있는 경우, 결제 금액을 입력해주세요.</li>
                                <li>정산은 매월 말일 기준으로 진행됩니다.</li>
                            </ul>
                        </div>
                    </div>
                
                <!-- 가격 정보 섹션 -->
                <div class="event-form-section">
                    <h3 class="event-section-title">가격 정보</h3>
                    
                        <!-- 이벤트 가격 -->
                        <div class="event-form-group">
                            <label class="event-form-label">서비스 가격</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" name="price" class="event-form-input" placeholder="가격을 입력하세요" id="eventPrice" style="flex: 1;" required>
                                <span style="font-size: 16px; color: #2c3e50; font-weight: 600;">원</span>
                            </div>
                            <div class="event-form-note">서비스 가격을 숫자로만 입력해주세요. (예: 290000)</div>
                        </div>
                    
                        <!-- VAT -->
                        <div class="event-form-group">
                            <label class="event-form-label">VAT</label>
                            <div class="event-radio-group">
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="vatIncluded" value="true" checked>
                                    <label class="event-radio-label">포함</label>
                                </div>
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="vatIncluded" value="false">
                                    <label class="event-radio-label">비대상</label>
                                </div>
                            </div>
                            <div class="event-form-note">VAT가 부과되는 시술은 VAT가 포함된 가격으로 입력해야 합니다.</div>
                        </div>
                    
                    <!-- 마취비 -->
                    <div class="event-form-group">
                        <label class="event-form-label">마취비</label>
                        <div class="event-radio-group">
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="anesthesia" value="included" checked>
                                <label class="event-radio-label">포함</label>
                            </div>
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="anesthesia" value="none">
                                <label class="event-radio-label">없음</label>
                            </div>
                        </div>
                        <div class="event-form-note">[없음]은 추가비용이 드는 수면마취가 필수적이지 않은 경우에만 가능합니다. 이를 어길시 패널티가 적용될 수 있습니다.</div>
                    </div>
                    
                    <!-- 사후관리비 -->
                    <div class="event-form-group">
                        <label class="event-form-label">사후관리비</label>
                        <div class="event-radio-group">
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="postCare" value="included" checked>
                                <label class="event-radio-label">포함</label>
                            </div>
                            <div class="event-radio-item">
                                <input type="radio" class="event-radio" name="postCare" value="none">
                                <label class="event-radio-label">없음</label>
                            </div>
                        </div>
                            <div class="event-form-note">[없음]은 사후관리가 필수적이지 않은 경우에만 가능합니다. 이를 어길시 패널티가 적용될 수 있습니다.</div>
                        </div>
                        
                        <!-- 환불 가능 여부 -->
                        <div class="event-form-group">
                            <label class="event-form-label">환불 가능 여부</label>
                            <div class="event-radio-group">
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="isRefundable" value="true" checked>
                                    <label class="event-radio-label">환불 가능</label>
                                </div>
                                <div class="event-radio-item">
                                    <input type="radio" class="event-radio" name="isRefundable" value="false">
                                    <label class="event-radio-label">환불 불가</label>
                                </div>
                            </div>
                            <div class="event-form-note">환불 가능 여부를 선택해주세요.</div>
                        </div>
                        
                        <!-- 숨겨진 필드들 -->
                        <input type="hidden" name="currency" value="KRW">
                        <input type="hidden" name="description" value="">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/crm/js/company_sidebar.js"></script>
    <script src="/crm/js/company_header.js"></script>
    <script>
        // 이벤트 등록 페이지 JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // 이벤트 제목 글자 수 카운터
            const titleInput = document.querySelector('input[placeholder*="사각턱보톡스"]');
            const charCounter = document.querySelector('.event-char-counter');
            
            if (titleInput && charCounter) {
                titleInput.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    charCounter.textContent = `${currentLength} / 100`;
                });
            }
            
            // 자유 태그 기능
            const freeTagInput = document.getElementById('freeTagInput');
            const freeTagsContainer = document.getElementById('freeTagsContainer');
            let freeTagCount = 0;
            
            if (freeTagInput) {
                freeTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim() && freeTagCount < 5) {
                        e.preventDefault();
                        addFreeTag(this.value.trim());
                        this.value = '';
                    }
                });
            }
            
            // 시술명 태그 기능
            const procedureTagInput = document.getElementById('procedureTagInput');
            const procedureTagsContainer = document.getElementById('procedureTagsContainer');
            let procedureTagCount = 2; // 이미 2개가 있음
            
            if (procedureTagInput) {
                procedureTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim() && procedureTagCount < 8) {
                        e.preventDefault();
                        addProcedureTag(this.value.trim());
                        this.value = '';
                    }
                });
            }
        });
        
        // 자유 태그 추가
        function addFreeTag(tagText) {
            const container = document.getElementById('freeTagsContainer');
            const tagDiv = document.createElement('div');
            tagDiv.className = 'event-tag';
            tagDiv.innerHTML = `
                <span>${tagText}</span>
                <button class="event-tag-remove" onclick="removeTag(this)">×</button>
            `;
            
            const input = document.getElementById('freeTagInput');
            container.insertBefore(tagDiv, input);
            
            const freeTagCount = document.querySelectorAll('#freeTagsContainer .event-tag').length;
            if (freeTagCount >= 5) {
                input.style.display = 'none';
            }
        }
        
        // 시술명 태그 추가
        function addProcedureTag(tagText) {
            const container = document.getElementById('procedureTagsContainer');
            const tagDiv = document.createElement('div');
            tagDiv.className = 'event-tag';
            tagDiv.innerHTML = `
                <span>${tagText}</span>
                <button class="event-tag-remove" onclick="removeTag(this)">×</button>
            `;
            
            const input = document.getElementById('procedureTagInput');
            container.insertBefore(tagDiv, input);
            
            const procedureTagCount = document.querySelectorAll('#procedureTagsContainer .event-tag').length;
            if (procedureTagCount >= 8) {
                input.style.display = 'none';
            }
        }
        
        // 태그 제거
        function removeTag(button) {
            const tag = button.parentElement;
            const container = tag.parentElement;
            tag.remove();
            
            // 입력 필드 다시 표시
            const input = container.querySelector('.event-tag-input');
            if (input) {
                input.style.display = 'block';
            }
        }
        
        // 이벤트 승인 요청 버튼
        document.querySelector('.event-approval-btn').addEventListener('click', async function() {
            // 태그 데이터 수집
            const freeTags = Array.from(document.querySelectorAll('#freeTagsContainer .event-tag span')).map(span => span.textContent);
            const procedureTags = Array.from(document.querySelectorAll('#procedureTagsContainer .event-tag span')).map(span => span.textContent);
            
            // JSON 데이터 구성
            const formData = {
                name: document.querySelector('input[name="name"]')?.value || '',
                startDate: document.querySelector('input[name="startDate"]')?.value || '',
                endDate: document.querySelector('input[name="endDate"]')?.value || '',
                genderTarget: document.querySelector('input[name="genderTarget"]:checked')?.value || 'ALL',
                targetCountry: document.querySelector('input[name="targetCountry"]:checked')?.value || 'KOR',
                tags: freeTags.join(','),
                serviceCategory: procedureTags.join(','),
                price: parseFloat(document.querySelector('input[name="price"]')?.value || '0'),
                vatIncluded: document.querySelector('input[name="vatIncluded"]:checked')?.value === 'true',
                isRefundable: document.querySelector('input[name="isRefundable"]:checked')?.value === 'true',
                currency: 'KRW',
                description: ''
            };
            
            // 필수 필드 검증
            if (!formData.name.trim()) {
                alert('의료 서비스 제목을 입력해주세요.');
                return;
            }
            
            if (!formData.price || formData.price <= 0) {
                alert('의료 서비스 가격을 올바르게 입력해주세요.');
                return;
            }
            
            if (!formData.startDate || !formData.endDate) {
                alert('의료 서비스 기간을 선택해주세요.');
                return;
            }
            
            try {
                // fetch로 JSON 데이터 전송
                const response = await fetch('/api/medical-services/item/1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('의료 서비스 등록이 완료되었습니다.');
                } else {
                    alert('의료 서비스 등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('서버 오류가 발생했습니다.');
            }
        });
    </script>
</body>
</html>
