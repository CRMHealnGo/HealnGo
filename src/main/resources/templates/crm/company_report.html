<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리포트 & 통계 - HealnGo</title>
    <link rel="stylesheet" href="/crm/css/company_report.css">
    <link rel="stylesheet" href="/crm/css/company_header.css">
    <link rel="stylesheet" href="/crm/css/company_sidebar.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="layout">
        <!-- 사이드바 -->
        <div th:replace="common/company_sidebar :: company_sidebar"></div>
        
        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <!-- 헤더 -->
            <div th:replace="common/company_header :: company_header"></div>
            
            <!-- 콘텐츠 영역 -->
            <div class="content-wrapper">
                <div class="page-header">
                    <h1>리포트 & 통계</h1>
                </div>
                
                <!-- 대시보드 콘텐츠 -->
                <div class="dashboard-content">
                    <!-- 상단 섹션 -->
                    <div class="top-section">
                        <!-- 시간별 예약 리포트 -->
                        <div class="sales-report-card">
                            <div class="card-header">
                                <h2>시간별 예약 현황</h2>
                                <a href="/company/company_reservation_management" class="view-all-link">View all ></a>
                            </div>
                            <div class="chart-container">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 우측 패널 -->
                        <div class="right-panel">
                            <!-- 핵심 지표 -->
                            <div class="key-indicators-card">
                                <h3>핵심 지표</h3>
                                <div class="indicator-item">
                                    <span class="indicator-label">총 예약 건수</span>
                                    <div class="indicator-value">
                                        <span class="value" th:text="${keyIndicators.totalReservations}">1,230</span>
                                        <span class="trend trend-low">
                                            <i class="fas fa-arrow-down"></i>
                                            <span>Low</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="indicator-item">
                                    <span class="indicator-label">재방문 건수</span>
                                    <div class="indicator-value">
                                        <span class="value" th:text="${keyIndicators.repeatVisits}">450</span>
                                    </div>
                                </div>
                                <div class="indicator-item">
                                    <span class="indicator-label">평균 만족도</span>
                                    <div class="indicator-value">
                                        <span class="value" th:text="${keyIndicators.averageSatisfaction}">4.8</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 최근 활동 -->
                            <div class="recent-activity-card">
                                <h3>최근 활동</h3>
                                <div class="activity-list">
                                    <div class="activity-item" th:each="activity : ${recentActivities}">
                                        <div class="activity-icon" th:classappend="${'icon-' + activity.color}">
                                            <i th:class="${activity.icon}"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title" th:text="${activity.title}">신규 상담 완료</div>
                                            <div class="activity-time" th:text="${activity.time}">2시간 전</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 하단 리포트 카드들 -->
                    <div class="report-cards-section">
                        <div class="report-card" th:each="card : ${reportCards}" th:classappend="${'card-' + card.color}">
                            <div class="card-icon">
                                <i th:class="${card.icon}"></i>
                            </div>
                            <div class="card-content">
                                <h4 th:text="${card.title}">서비스별 예약률</h4>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 추가 차트 섹션 -->
                    <div class="additional-charts-section" style="margin-top: 30px;">
                        <!-- 일일 매출 그래프 -->
                        <div class="sales-report-card" style="margin-bottom: 30px;">
                            <div class="card-header">
                                <h2>일일 매출 리포트</h2>
                                <a href="/company/company_reservation_management" class="view-all-link">View all ></a>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="dailySalesChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 최근 한 달 매출 그래프 -->
                        <div class="sales-report-card">
                            <div class="card-header">
                                <h2>최근 한 달 매출 현황</h2>
                                <a href="/company/company_reservation_management" class="view-all-link">View all ></a>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="monthlySalesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 스크립트 -->
    <script src="/static/crm/js/company_header.js"></script>
    <script src="/static/crm/js/company_sidebar.js"></script>
    <script src="/static/crm/js/company_report.js"></script>
    
    <script th:inline="javascript">
        // Thymeleaf에서 시간별 예약 데이터 전달
        /*<![CDATA[*/
        const hourlyReservationData = [[${dailySalesData}]];
        /*]]>*/
        
        console.log('=== 시간별 예약 데이터 (프론트엔드) ===');
        console.log('데이터:', hourlyReservationData);
        console.log('=====================================');
        
        // 차트 생성
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // 시간대와 예약 수 분리
            const hours = hourlyReservationData.map(item => item.hour);
            const reservationCounts = hourlyReservationData.map(item => item.reservationCount);
            
            // 최대값 계산 (여유 있게 표시)
            const maxCount = Math.max(...reservationCounts, 5);
            const yAxisMax = Math.ceil(maxCount * 1.2);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: '시간별 예약 수',
                            data: reservationCounts,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '예약 수: ' + context.parsed.y + '건';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                stepSize: Math.ceil(yAxisMax / 5),
                                precision: 0,
                                callback: function(value) {
                                    return value + '건';
                                }
                            },
                            grid: {
                                color: '#E5E7EB',
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            // ========== 새로 추가된 차트들 ==========
            
            // 일일 매출 그래프 (오늘 시간별 매출)
            const dailySalesCtx = document.getElementById('dailySalesChart');
            if (dailySalesCtx) {
                const dailySalesData = [[${dailyRevenueData}]];
                
                console.log('=== 일일 매출 데이터 ===');
                console.log('데이터:', dailySalesData);
                
                const dailyHours = dailySalesData.map(item => item.hour);
                const dailyRevenue = dailySalesData.map(item => item.revenue);
                
                const maxDailyRevenue = Math.max(...dailyRevenue, 10000);
                const yMaxDaily = Math.ceil(maxDailyRevenue * 1.2);
                
                new Chart(dailySalesCtx, {
                    type: 'bar',
                    data: {
                        labels: dailyHours,
                        datasets: [{
                            label: '시간별 매출 (원)',
                            data: dailyRevenue,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '매출: ' + context.parsed.y.toLocaleString() + '원';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yMaxDaily,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + '원';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }
            
            // 최근 한 달 매출 그래프 (일별 매출)
            const monthlySalesCtx = document.getElementById('monthlySalesChart');
            if (monthlySalesCtx) {
                const monthlySalesData = [[${monthlyRevenueData}]];
                
                console.log('=== 월간 매출 데이터 ===');
                console.log('데이터:', monthlySalesData);
                
                const monthlyDays = monthlySalesData.map(item => item.day);
                const monthlyRevenue = monthlySalesData.map(item => item.revenue);
                
                const maxMonthlyRevenue = Math.max(...monthlyRevenue, 10000);
                const yMaxMonthly = Math.ceil(maxMonthlyRevenue * 1.2);
                
                new Chart(monthlySalesCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyDays,
                        datasets: [{
                            label: '일별 매출 (원)',
                            data: monthlyRevenue,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#27ae60',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '매출: ' + context.parsed.y.toLocaleString() + '원';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yMaxMonthly,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + '원';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 0,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
