<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>즐겨찾기</title>
    <link rel="stylesheet" href="/resources/css/favorite.css">
    <link rel="stylesheet" href="/resources/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- 헤더 -->
    <div th:replace="~{common/header :: header}"></div>

<div class="favorite-container">
    <!-- 상단 제목 섹션 -->
    <div class="favorite-header">
        <div class="favorite-icon">
            <i class="fas fa-heart"></i>
        </div>
        <h1 class="favorite-title">즐겨찾기</h1>
    </div>

    <!-- 즐겨찾기 목록 -->
    <div class="favorite-list">
        <!-- 로그인하지 않은 사용자 메시지 -->
        <div th:if="${!isLoggedIn}" class="login-prompt">
            <div class="login-prompt-content">
                <i class="fas fa-heart-broken"></i>
                <h3>로그인이 필요한 서비스입니다</h3>
                <p>즐겨찾기 기능을 사용하려면 로그인해주세요.</p>
                <div class="login-actions">
                    <a th:href="@{/login}" class="login-btn">로그인</a>
                    <a th:href="@{/signup}" class="signup-btn">회원가입</a>
                </div>
            </div>
        </div>
        
        <!-- 로그인한 사용자 즐겨찾기 목록 -->
        <div th:if="${isLoggedIn}" id="favorites-content" style="width: 100%;">
            <!-- JavaScript로 내용이 채워집니다 -->
            <p style="text-align: center; color: #999;">로딩 중...</p>
        </div>
    </div>
</div>

<!-- 상세보기 모달 -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close" title="닫기">&times;</span>
        <div id="modalBody">
            <!-- 상세 내용이 여기에 동적으로 로드됩니다 -->
        </div>
    </div>
</div>

<script src="/resources/js/favorite.js"></script>

<!-- 서버 데이터를 JavaScript로 전달 -->
<script th:inline="javascript">
    // 서버에서 전달된 데이터를 JavaScript에서 사용할 수 있도록 설정
    window.serverData = {
        isLoggedIn: /*[[${isLoggedIn}]]*/ false,
        totalCount: /*[[${totalCount}]]*/ 0,
        favorites: /*[[${favorites}]]*/ []
    };
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        console.log('Server data:', window.serverData);
        
        // 서버 데이터 로드
        loadFavorites();
    });
    
    // 즐겨찾기 데이터 로드
    function loadFavorites() {
        console.log('loadFavorites called');
        console.log('isLoggedIn:', window.serverData.isLoggedIn);
        console.log('favorites:', window.serverData.favorites);
        
        // 서버에서 전달된 데이터 사용
        if (window.serverData.isLoggedIn) {
            const favorites = window.serverData.favorites;
            if (favorites && favorites.length > 0) {
                console.log('Rendering favorites:', favorites.length);
                renderFavorites(favorites);
            } else {
                console.log('No favorites, rendering empty state');
                renderEmptyFavorites();
            }
        } else {
            console.log('User not logged in');
        }
    }
    
    // 즐겨찾기 목록 렌더링
    function renderFavorites(favorites) {
        const container = document.getElementById('favorites-content');
        
        if (!favorites || favorites.length === 0) {
            renderEmptyFavorites();
            return;
        }
        
        container.innerHTML = favorites.map((favorite, index) => `
            <div class="favorite-item" data-id="${favorite.id}" data-hospital="${favorite.name}">
                <div class="item-banner">
                    <span class="day-number">${index + 1}</span>
                </div>
                <div class="item-content">
                    <div class="item-info">
                        <h3 class="hospital-name">${favorite.name}</h3>
                        <div class="hospital-details">
                            <p class="hospital-address">
                                <i class="fas fa-map-marker-alt"></i>
                                ${favorite.address || '주소 정보 없음'}
                            </p>
                            <p class="hospital-phone">
                                <i class="fas fa-phone"></i>
                                ${favorite.phone || '전화번호 정보 없음'}
                            </p>
                            <p class="hospital-hours">
                                <i class="fas fa-clock"></i>
                                운영시간 정보 없음
                            </p>
                        </div>
                        <div class="hospital-tags">
                            <span class="tag">${favorite.region || ''}</span>
                            <span class="tag">${favorite.subregion || ''}</span>
                            ${favorite.category ? `<span class="tag">${favorite.category}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="item-actions">
                    <button class="btn-detail" onclick="showDetail(${favorite.id})">상세보기</button>
                    <button class="btn-remove" onclick="removeFavorite(${favorite.id})" title="삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    // 빈 즐겨찾기 상태 렌더링
    function renderEmptyFavorites() {
        const container = document.getElementById('favorites-content');
        container.innerHTML = `
            <div class="empty-favorites">
                <div class="empty-icon">
                    <i class="fas fa-heart"></i>
                    <i class="fas fa-plus empty-plus"></i>
                </div>
                <div class="empty-content">
                    <h3>아직 즐겨찾기한 병원이 없습니다</h3>
                    <p class="empty-description">마음에 드는 병원을 찾아서 즐겨찾기에 추가해보세요!</p>
                </div>
                <div class="empty-actions">
                    <a href="/main" class="btn-primary">병원 찾아보기</a>
                </div>
            </div>
        `;
    }
    
    // 찜 삭제 함수
    async function removeFavorite(itemId) {
        try {
            const response = await fetch(`/favorite/remove/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // 페이지 새로고침
                window.location.reload();
            } else if (response.status === 401) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login';
            } else {
                alert('삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('네트워크 오류가 발생했습니다.');
        }
    }
    
    // 상세보기 함수
    function showDetail(itemId) {
        // 상세 페이지로 이동
        window.location.href = `/detail/${itemId}`;
    }
</script>

<!-- 푸터 -->
<div th:replace="~{common/footer :: footer}"></div>
</body>
</html>
