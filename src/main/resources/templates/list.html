<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>HealnGo - ë³‘ì› ëª©ë¡</title>
    <link rel="stylesheet" href="/resources/css/styles.css">
    <link rel="stylesheet" href="/resources/css/list.css">
    <link rel="stylesheet" href="/resources/css/pagination.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        window.APP_CTX = '';
    </script>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<div class="main-container">
    <!-- ì™¼ìª½: ë³‘ì› ëª©ë¡ -->
    <div class="left-panel">
        <!-- ì§€ì—­ ì •ë³´ -->
        <div class="region-info">
            <h2>ì„ íƒëœ ì§€ì—­: <span th:text="${region != null ? region : 'ì „êµ­'}">ì „êµ­</span></h2>
        </div>

        <!-- ê²°ê³¼ ì •ë³´ -->
        <div class="result-info">
            <div class="total-count">
                ì´ <span th:text="${totalCount != null ? totalCount : '1,221'}">1,221</span>ê±´
            </div>
        </div>

        <!-- ë³‘ì› ëª©ë¡ (DB ë°ì´í„°ë§Œ) -->
        <div class="hospital-list">
            <!-- DB ë°ì´í„° -->
            <div th:each="h : ${lists}" class="hospital-item"
                 th:data-item-id="${h.id}"
                 th:data-company-id="${h.ownerCompany?.companyId}"
                 th:data-hospital="${h.name}"
                 th:data-address="${h.address}"
                 th:data-phone="${h.phone}"
                 th:data-homepage="${h.homepage}"
                 th:data-region="${h.region}"
                 th:data-subregion="${h.subregion}"
                 th:data-category="${h.category}">
                <div class="hospital-heart" onclick="toggleFavorite(this)">
                    <i class="far fa-heart"></i>
                </div>
                <div class="hospital-name" th:text="${h.name}">ë³‘ì›ëª…</div>
            </div>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" id="pagination-content">
            <!-- ì´ì „ -->
            <a class="page-link"
               th:if="${pageNo > 1}"
               th:href="@{/list(
            region=${region == 'ì „êµ­' ? null : region},
            subRegion=${subRegion},
            category=${category},
            pageNo=${pageNo - 1},
            amount=${amount}
       )}">&laquo;</a>

            <!-- ê°€ìš´ë° í˜ì´ì§€ë“¤ -->
            <a class="page-link"
               th:each="p : ${#numbers.sequence(startPage, endPage)}"
               th:classappend="${p} == ${pageNo} ? 'active' : ''"
               th:text="${p}"
               th:href="@{/list(
            region=${region == 'ì „êµ­' ? null : region},
            subRegion=${subRegion},
            category=${category},
            pageNo=${p},
            amount=${amount}
       )}">1</a>

            <!-- ë‹¤ìŒ -->
            <a class="page-link"
               th:if="${pageNo < totalPages}"
               th:href="@{/list(
            region=${region == 'ì „êµ­' ? null : region},
            subRegion=${subRegion},
            category=${category},
            pageNo=${pageNo + 1},
            amount=${amount}
       )}">&raquo;</a>
        </div>

    </div>

    <!-- ì˜¤ë¥¸ìª½: ë³‘ì› ìƒì„¸ ì •ë³´ -->
    <div class="right-panel">
        <div class="detail-container">
            <div class="detail-placeholder">
                <i class="fas fa-hospital"></i>
                <p>ë³‘ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>

            <div class="detail-content" style="display: none;">
                <!-- AJAXë¡œ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</div>

<script>
    // ===== ê³µí†µ ìœ í‹¸ =====
    function isBlank(v){ return !v || /^\s*$/.test(v); }

    function websiteToHtml(raw){
        const text = (raw || '').trim();
        if (isBlank(text) || text === '-' || text === 'í™ˆí˜ì´ì§€ ì •ë³´ ì—†ìŒ') return 'í™ˆí˜ì´ì§€ ì •ë³´ ì—†ìŒ';
        let url = text;
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
        try { new URL(url); } catch { return 'í™ˆí˜ì´ì§€ ì •ë³´ ì—†ìŒ'; }
        return `<a href="${url}" target="_blank" rel="noopener">${text}</a>`;
    }

    // ===== ë³‘ì› ì¹´ë“œ í´ë¦­ ë°”ì¸ë”© =====
    document.addEventListener('DOMContentLoaded', function() {
        // ì°œ ìƒíƒœ ì²´í¬
        checkFavoriteStatus();

        document.querySelectorAll('.hospital-item').forEach(item => {
            item.addEventListener('click', async function(e) {
                // í•˜íŠ¸ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™ ë°©ì§€
                if (e.target.closest('.hospital-heart')) return;

                // selected í† ê¸€
                document.querySelectorAll('.hospital-item').forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');

                const itemId = this.dataset.itemId;
                const hospitalName = this.dataset.hospital;
                
                console.log('ğŸŸ¢ğŸŸ¢ğŸŸ¢ ë³‘ì› í´ë¦­! ğŸŸ¢ğŸŸ¢ğŸŸ¢');
                console.log('itemId:', itemId, '| ë³‘ì›ëª…:', hospitalName);
                
                // í´ë¦­ ë¡œê·¸ ì „ì†¡
                if (itemId) {
                    try {
                        const response = await fetch(`/api/clicks/item/${itemId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        console.log('âœ… í´ë¦­ ë¡œê·¸ ì „ì†¡ ì™„ë£Œ:', response.status);
                    } catch (error) {
                        console.error('âŒ í´ë¦­ ë¡œê·¸ ì‹¤íŒ¨:', error);
                    }
                }
                
                await showHospitalDetail(itemId, hospitalName, this.dataset);
            });
        });
    });

    // ===== ìƒì„¸ íŒ¨ë„ í‘œì‹œ (ì‹¤ì œ ì„œë¹„ìŠ¤ í¬í•¨) =====
    async function showHospitalDetail(itemId, hospitalName, dataset) {
        const placeholder = document.querySelector('.detail-placeholder');
        const detailContent = document.querySelector('.detail-content');
        if (!placeholder || !detailContent) return;

        placeholder.style.display = 'none';
        detailContent.style.display = 'block';

        const websiteHtml = websiteToHtml(dataset.homepage);
        const phone = (!isBlank(dataset.phone) && dataset.phone !== 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ') ? dataset.phone : 'ì—°ë½ì²˜ ì •ë³´ ì—†ìŒ';
        const address = !isBlank(dataset.address) ? dataset.address : 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

        // ì„œë¹„ìŠ¤ ëª©ë¡ ì¡°íšŒ
        let services = [];
        try {
            const res = await fetch(`/api/items/${itemId}/services`);
            if (res.ok) {
                services = await res.json();
            } else {
                console.warn('ì„œë¹„ìŠ¤ API ì‘ë‹µ ì‹¤íŒ¨', res.status);
            }
        } catch (e) {
            console.warn('ì„œë¹„ìŠ¤ API í˜¸ì¶œ ì˜¤ë¥˜', e);
        }

        const servicesHtml = (Array.isArray(services) && services.length > 0)
            ? services.map(s => {
                const tags = (s.tags || '')
                    .split(',')
                    .map(t => t.trim())
                    .filter(Boolean)
                    .map(t => `<span class="service-hashtag">#${t}</span>`)
                    .join('');
                const priceText = (s.price != null ? s.price : '') + (s.currency ? ' ' + s.currency : '');
                return `
                <div class="service-item" onclick="goToServiceDetail(${s.serviceId})" style="cursor: pointer;">
                    <div class="service-image">ì´ë¯¸ì§€</div>
                    <div class="service-content">
                        <h3 class="service-title">${s.name || 'ì„œë¹„ìŠ¤'}</h3>
                        <div class="service-hashtags">${tags}</div>
                        <div class="service-info">
                            <span class="service-price">${priceText || 'ê°€ê²© ë¬¸ì˜'}</span>
                            <div class="service-rating"><span>${s.serviceCategory || ''}</span></div>
                        </div>
                        ${s.description ? `<p style="margin-top:8px;color:#666;">${s.description}</p>` : ''}
                    </div>
                </div>`;
            }).join('')
            : `<div class="detail-empty"><p>ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;

        detailContent.innerHTML = `
            <div class="hospital-detail active">
                <div class="hospital-header">
                    <h1 class="hospital-title">${hospitalName}</h1>
                </div>

                <div class="hospital-info-table">
                    <table>
                        <tr><th>í™ˆí˜ì´ì§€</th><td>${websiteHtml}</td></tr>
                        <tr><th>ì—°ë½ì²˜</th><td>${phone}</td></tr>
                        <tr><th>ìœ„ì¹˜</th><td>${address}</td></tr>
                    </table>
                </div>

                <div class="services-section">
                    ${servicesHtml}
                </div>

                <button class="consultation-btn" onclick="startConsultation(this)">ë³‘ì› ìƒë‹´ ì‹ ì²­</button>
            </div>
        `;
    }

    // ===== ì„œë¹„ìŠ¤ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ =====
    function goToServiceDetail(serviceId) {
        if (serviceId) {
            window.location.href = `/service/detail/${serviceId}`;
        }
    }

    // ===== ìƒë‹´ ì‹ ì²­ ê¸°ëŠ¥ =====
    async function startConsultation(button) {
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const isLoggedIn = await isUserLoggedIn();
        if (!isLoggedIn) {
            alert('ìƒë‹´ ì‹ ì²­ì„ ìœ„í•´ì„œëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        // í˜„ì¬ ì„ íƒëœ ë³‘ì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„)
        let hospitalItem = button.closest('.hospital-item');

        // hospital-itemì„ ì°¾ì§€ ëª»í–ˆë‹¤ë©´ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì‹œë„
        if (!hospitalItem) {
            // í˜„ì¬ ì„ íƒëœ ë³‘ì› ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            if (window.selectedHospital) {
                hospitalItem = window.selectedHospital;
            } else {
                // ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¦­ëœ ë³‘ì› ì •ë³´ ì‚¬ìš©
                hospitalItem = document.querySelector('.hospital-item.selected');
            }
        }

        if (!hospitalItem) {
            alert('ë³‘ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³‘ì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const itemId = hospitalItem.getAttribute('data-item-id');
        const companyId = hospitalItem.getAttribute('data-company-id');
        const hospitalName = hospitalItem.getAttribute('data-hospital');
        const hospitalAddress = hospitalItem.getAttribute('data-address');
        const hospitalPhone = hospitalItem.getAttribute('data-phone');

        console.log('ë³‘ì› ì •ë³´:', { itemId, companyId, hospitalName, hospitalAddress, hospitalPhone });

        if (!companyId || companyId === 'null') {
            alert('ì´ ë³‘ì›ì€ ì•„ì§ ì—…ì²´ ë“±ë¡ì´ ë˜ì§€ ì•Šì•„ ì±„íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        // ìƒë‹´ ì‹ ì²­ í™•ì¸
        if (confirm(`${hospitalName}ê³¼ ìƒë‹´ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ ì—…ì²´ ì •ë³´ ì „ë‹¬
            const chatUrl = `/chat?companyId=${companyId}&companyName=${encodeURIComponent(hospitalName)}&companyAddress=${encodeURIComponent(hospitalAddress)}&companyPhone=${encodeURIComponent(hospitalPhone)}`;
            console.log('ì±„íŒ… URL:', chatUrl);
            window.location.href = chatUrl;
        }
    }

    // ë³‘ì› ì„ íƒ í•¨ìˆ˜
    function selectHospital(hospitalElement) {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.hospital-item').forEach(item => {
            item.classList.remove('selected');
        });

        // í˜„ì¬ ì„ íƒëœ ë³‘ì› í‘œì‹œ
        hospitalElement.classList.add('selected');

        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        window.selectedHospital = hospitalElement;

        console.log('ì„ íƒëœ ë³‘ì›:', {
            id: hospitalElement.getAttribute('data-item-id'),
            name: hospitalElement.getAttribute('data-hospital'),
            address: hospitalElement.getAttribute('data-address'),
            phone: hospitalElement.getAttribute('data-phone')
        });
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
    function isUserLoggedIn() {
        // ì‹¤ì œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ì„ ìœ„í•´ ì„œë²„ API í˜¸ì¶œ
        return fetch('/favorite/check-login', {
            method: 'GET',
            credentials: 'include' // ì¿ í‚¤ í¬í•¨
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return false;
            }
        })
        .then(data => {
            return data === true;
        })
        .catch(error => {
            console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            return false;
        });
    }

    // ì¿ í‚¤ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    function getSessionStorage(name) {
        return sessionStorage.getItem(name);
    }

    // ===== í˜ì´ì§€ ë³€ê²½(ë”ë¯¸ ë²„íŠ¼ìš©) =====
    function changePage(pageNumber) {
        document.querySelectorAll('.pagination button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        console.log('í˜ì´ì§€', pageNumber, 'ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        // ì‹¤ì œ ì‚¬ìš© ì‹œ location.href ê°±ì‹  ë˜ëŠ” AJAX í˜ì´ì§€ ë¡œë”©ìœ¼ë¡œ êµì²´
    }

    // ===== ì°œ(í•˜íŠ¸) =====
    function toggleFavorite(element) {
        event.stopPropagation();
        const heartIcon = element.querySelector('i');
        const hospitalItem = element.closest('.hospital-item');
        const itemId = hospitalItem.dataset.itemId;
        if (!itemId) return console.error('Item ID not found');

        if (heartIcon.classList.contains('far')) {
            addToFavorite(itemId, element, heartIcon);
        } else {
            removeFromFavorite(itemId, element, heartIcon);
        }
    }

    async function addToFavorite(itemId, element, heartIcon) {
        try {
            const response = await fetch(`/favorite/add/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            if (response.ok) {
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
                element.classList.add('favorited');
            } else if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                alert('ì°œí•˜ê¸° ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function removeFromFavorite(itemId, element, heartIcon) {
        try {
            const response = await fetch(`/favorite/remove/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            if (response.ok) {
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
                element.classList.remove('favorited');
            } else if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                alert('ì°œí•˜ê¸° ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œ ìƒíƒœ ì´ˆê¸°í™” =====
    async function checkFavoriteStatus() {
        const hospitalItems = document.querySelectorAll('.hospital-item');
        for (const item of hospitalItems) {
            const itemId = item.dataset.itemId;
            if (!itemId) continue;
            try {
                const response = await fetch(`/favorite/check/${itemId}`);
                if (response.ok) {
                    const isFavorite = await response.json();
                    if (isFavorite) {
                        const heartIcon = item.querySelector('.hospital-heart i');
                        const heartContainer = item.querySelector('.hospital-heart');
                        if (heartIcon && heartContainer) {
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas');
                            heartContainer.classList.add('favorited');
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking favorite status:', error);
            }
        }
    }
</script>

<div th:replace="~{common/footer :: footer}"></div>
</body>
</html>