<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.ApiRound.mapper.ClickLogMapper">

    <!-- 클릭 로그 저장 (MySQL) -->
    <insert id="insertClickLog">
        INSERT INTO click_logs (company_id, clicked_at)
        VALUES (#{companyId}, NOW())
    </insert>

    <!-- 최근 7일간 업체별 클릭 수 + 업체 정보 (내림차순) -->
    <select id="getClickCountsLast7Days"
            resultType="com.example.ApiRound.dto.CompanyClickCountDto">
        SELECT
        c.company_id  AS companyId,
        i.name        AS companyName,
        COUNT(*)      AS clickCount,
        i.region      AS region,
        i.subregion   AS subregion,
        i.category    AS category
        FROM click_logs c
        JOIN item_list i
        ON c.company_id = i.id
        WHERE c.clicked_at >= NOW() - INTERVAL 7 DAY
        GROUP BY
        c.company_id, i.name, i.region, i.subregion, i.category
        ORDER BY clickCount DESC
    </select>

    <!-- 최근 7일 기준, 제일 많이 클릭된 업체 3개 -->
    <!-- MySQL에서는 LIMIT로 바로 자르면 되므로 서브쿼리/ROWNUM 불필요 -->
    <select id="getTop3CompaniesLast7Days"
            resultType="com.example.ApiRound.dto.CompanyClickCountDto">
        SELECT
        c.company_id  AS companyId,
        i.name        AS companyName,
        COUNT(*)      AS clickCount,
        i.region      AS region,
        i.subregion   AS subregion,
        i.category    AS category
        FROM click_logs c
        JOIN item_list i
        ON c.company_id = i.id
        WHERE c.clicked_at >= NOW() - INTERVAL 7 DAY
        GROUP BY
        c.company_id, i.name, i.region, i.subregion, i.category
        ORDER BY clickCount DESC
        LIMIT 3
    </select>

</mapper>
