<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.ApiRound.mapper.ListMapper">

    <!-- result map -->
    <resultMap id="ListDtoResultMap" type="com.example.ApiRound.dto.ListDto">
        <id     column="id"            property="id"/>
        <result column="name"          property="name"/>
        <result column="region"        property="region"/>
        <result column="subregion"     property="subregion"/>
        <result column="address"       property="address"/>
        <result column="phone"         property="phone"/>
        <result column="homepage"      property="homepage"/>
        <result column="coord_x"       property="coordX"/>
        <result column="coord_y"       property="coordY"/>
        <result column="category"      property="category"/>
        <!-- i18n labels -->
        <result column="name_label"    property="nameLabel"/>
        <result column="address_label" property="addressLabel"/>
    </resultMap>

    <!-- 공통 select (i18n 조인 포함) -->
    <sql id="BaseSelectWithI18N">
        select
        i.id                                  as id,
        ifnull(i18n.name_label, i.name)       as name_label,
        ifnull(i18n.address_label, i.address) as address_label,

        i.name       as name,
        i.region     as region,
        i.subregion  as subregion,
        i.address    as address,
        i.phone      as phone,
        i.homepage   as homepage,
        i.coord_x    as coord_x,
        i.coord_y    as coord_y,
        i.category   as category
        from item_list i
        left join item_list_i18n i18n
        on i.id = i18n.item_id
        and i18n.locale = #{locale}
    </sql>

    <!-- 전체 리스트 -->
    <select id="findAll" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        order by i.id asc
    </select>

    <!-- 단건 조회 -->
    <select id="findById" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        where i.id = #{id}
    </select>

    <!-- 카테고리별 조회 -->
    <select id="findByCategory" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        where i.category like concat('%', #{category}, '%')
        order by i.id asc
    </select>

    <!-- 지역+구별+카테고리 조회 -->
    <select id="findByRegionAndCategory" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        <where>
            <if test="region != null and region != ''">
                and (i.region like concat('%', #{region}, '%')
                or  i.address like concat('%', #{region}, '%'))
            </if>
            <if test="subregion != null and subregion != ''">
                and (i.subregion like concat('%', #{subregion}, '%')
                or  i.address  like concat('%', #{subregion}, '%'))
            </if>
            <if test="category != null and category != ''">
                and i.category like concat('%', #{category}, '%')
            </if>
        </where>
        order by i.id asc
    </select>

    <!-- 전체 개수 -->
    <select id="countByRegionAndCategory" resultType="int">
        select count(*)
        from item_list i
        <where>
            <if test="region != null and region != ''">
                and (i.region like concat('%', #{region}, '%')
                or  i.address like concat('%', #{region}, '%'))
            </if>
            <if test="subregion != null and subregion != ''">
                and (i.subregion like concat('%', #{subregion}, '%')
                or  i.address  like concat('%', #{subregion}, '%'))
            </if>
            <if test="category != null and category != ''">
                and i.category like concat('%', #{category}, '%')
            </if>
        </where>
    </select>

    <!-- 페이징 조회 -->
    <select id="findByRegionAndCategoryPaged" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        <where>
            <if test="region != null and region != ''">
                and (i.region like concat('%', #{region}, '%')
                or  i.address like concat('%', #{region}, '%'))
            </if>
            <if test="subregion != null and subregion != ''">
                and (i.subregion like concat('%', #{subregion}, '%')
                or  i.address  like concat('%', #{subregion}, '%'))
            </if>
            <if test="category != null and category != ''">
                and i.category like concat('%', #{category}, '%')
            </if>
        </where>
        order by i.id asc
        limit #{amount} offset #{offset}
    </select>

    <!-- 카테고리별 총 개수 -->
    <select id="countByCategory" resultType="int">
        select count(*)
        from item_list
        where category like concat('%', #{category}, '%')
    </select>

    <!-- 카테고리별 페이징 조회 -->
    <select id="findByCategoryPaged" resultMap="ListDtoResultMap">
        <include refid="BaseSelectWithI18N"/>
        where i.category like concat('%', #{category}, '%')
        order by i.id asc
        limit #{amount} offset #{offset}
    </select>

    <!-- 카테고리 목록 -->
    <select id="getAllCategories" resultType="java.lang.String">
        select distinct category
        from item_list
        order by category
    </select>

    <!-- 병원 등록 -->
    <insert id="insert" parameterType="com.example.ApiRound.dto.ListDto">
        insert into item_list
        (name, region, subregion, address, phone, homepage, coord_x, coord_y, category)
        values
        (#{name}, #{region}, #{subregion}, #{address}, #{phone}, #{homepage}, #{coordX}, #{coordY}, #{category})
    </insert>

</mapper>
