<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업체 관리 - HealnGo</title>
    <link rel="stylesheet" href="/crm/css/admin_manage_company.css">
    <link rel="stylesheet" href="/crm/css/admin_manage_company_detail.css">
    <link rel="stylesheet" href="/crm/css/admin_sidebar.css">
    <link rel="stylesheet" href="/crm/css/admin_header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 사이드바 -->
        <div th:replace="common/admin_sidebar :: admin_sidebar"></div>
        
        <!-- 메인 콘텐츠 -->
        <div class="admin-content">
            <!-- 헤더 -->
            <div th:replace="common/admin_header :: admin_header"></div>
            
            <!-- 페이지 컨텐츠 -->
            <div class="page-content">
                <div class="content-main">
                    <!-- 브레드크럼 & 제목 -->
                    <div class="page-header">
                        <div class="breadcrumb">HealnGo, 관리자 모드</div>
                        <h1 class="page-title">업체 관리</h1>
                    </div>
                    
                    <!-- 통계 카드 -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" th:text="${totalCompanies}">0</div>
                            <div class="stat-label">전체 업체</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" th:text="${newThisMonth}">0</div>
                            <div class="stat-label">이번달 신규</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" th:text="${underSanction}">0</div>
                            <div class="stat-label">제재 중</div>
                        </div>
                    </div>
                    
                    <!-- 업체 관리 섹션 -->
                    <div class="company-management-section">
                        <div class="section-header">
                            <h2>업체 관리</h2>
                            <a href="#" class="view-all-link">View all ></a>
                        </div>
                        
                        <!-- 검색 바 -->
                        <div class="search-section">
                            <div class="search-input-wrapper">
                                <input type="text" placeholder="업체명 또는 ID로 검색" class="company-search">
                                <button class="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 필터 탭 -->
                        <div class="filter-tabs">
                            <button class="filter-tab" 
                                    th:classappend="${status == null or status == ''} ? 'active' : ''"
                                    onclick="location.href='/admin/companies'">
                                전체
                            </button>
                            <button class="filter-tab" 
                                    th:classappend="${status == 'APPROVED'} ? 'active' : ''"
                                    onclick="location.href='/admin/companies?status=APPROVED'">
                                정상
                            </button>
                            <button class="filter-tab" 
                                    th:classappend="${status == 'SUSPENDED'} ? 'active' : ''"
                                    onclick="location.href='/admin/companies?status=SUSPENDED'">
                                제재중
                            </button>
                            <button class="filter-tab" 
                                    th:classappend="${status == 'PENDING'} ? 'active' : ''"
                                    onclick="location.href='/admin/companies?status=PENDING'">
                                입점관리
                            </button>
                        </div>
                        
                        <!-- 업체 리스트 -->
                        <div class="company-list">
                            <!-- 실제 DB 데이터 반복 -->
                            <div th:each="company : ${companies}" 
                                 class="company-item"
                                 th:data-company-id="${company.ownerCompany.companyId}"
                                 th:data-company-name="${company.name}"
                                 th:data-item-id="${company.id}"
                                 th:data-approval-status="${company.ownerCompany.approvalStatus}"
                                 th:data-created-at="${company.ownerCompany.createdAt}"
                                 onclick="selectCompany(this)"
                                 style="cursor: pointer;">
                                <div class="company-info">
                                    <div class="company-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="company-details">
                                        <div class="company-id" th:text="'PN' + ${company.id}">PN0000000</div>
                                        <div class="company-name" th:text="${company.name}">업체명</div>
                                        <div class="company-status" 
                                             th:classappend="${company.ownerCompany.approvalStatus == 'APPROVED'} ? 'normal' : 
                                                           (${company.ownerCompany.approvalStatus == 'REPORTED'} ? 'report' : 'normal')"
                                             th:text="${company.ownerCompany.approvalStatus == 'APPROVED'} ? '정상' : 
                                                     (${company.ownerCompany.approvalStatus == 'REPORTED'} ? '신고 접수' : 
                                                      (${company.ownerCompany.approvalStatus == 'SUSPENDED'} ? '제재중' : '대기'))">상태</div>
                                    </div>
                                </div>
                                <div class="company-metrics">
                                    <div class="contract-date" 
                                         th:text="${company.ownerCompany.createdAt != null} ? '등록일 ' + ${#temporals.format(company.ownerCompany.createdAt, 'MMM dd, yyyy')} : '등록일 미정'">등록일</div>
                                    <div class="rating-info">
                                        <i class="fas fa-arrow-up"></i>
                                        <span class="rating">4.5</span>
                                        <i class="fas fa-star"></i>
                                        <span class="review-count">(0)</span>
                                    </div>
                                </div>
                                <div class="company-data-section">
                                    <div class="company-data">
                                        <div class="data-header">이 업체의 Data</div>
                                        <div class="data-items">
                                        <div class="data-item">
                                            <span class="data-label">상품</span>
                                            <span class="data-value" 
                                                  th:if="${company.name != null and !company.name.contains('(임시)')}"
                                                  th:text="${#vars['serviceCount_' + company.ownerCompany.companyId]}">0</span>
                                            <span class="data-value" 
                                                  th:if="${company.name != null and company.name.contains('(임시)')}">-</span>
                                        </div>
                                            <div class="data-item">
                                                <span class="data-label">리뷰</span>
                                                <span class="data-value" 
                                                      th:if="${company.name != null and !company.name.contains('(임시)')}"
                                                      th:text="${#vars['reviewCount_' + company.ownerCompany.companyId]}">0</span>
                                                <span class="data-value" 
                                                      th:if="${company.name != null and company.name.contains('(임시)')}">-</span>
                                            </div>
                                        </div>
                                        <div class="sales-info">
                                            <span class="sales-amount">0 만원</span>
                                            <span class="sales-label">이번달 매출</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 승인 버튼 (PENDING 상태일 때만 표시) -->
                                    <div class="approval-actions" th:if="${company.ownerCompany.approvalStatus == 'PENDING'}">
                                        <button class="approve-btn" 
                                                th:data-company-id="${company.ownerCompany.companyId}"
                                                th:data-company-name="${company.name}"
                                                onclick="approveCompany(this)">
                                            <i class="fas fa-check"></i>
                                            입점 승인
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 업체가 없을 때 -->
                            <div th:if="${#lists.isEmpty(companies)}" class="no-companies">
                                <div class="no-companies-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <div class="no-companies-text">
                                    <h3>등록된 업체가 없습니다</h3>
                                    <p>아직 승인된 업체가 없습니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 우측 사이드바 -->
                <div class="content-sidebar">
                    <!-- 업체 상세 정보 -->
                    <div class="sidebar-section">
                        <h3>업체 상세 정보</h3>
                        <div class="selected-company">
                            <div class="company-logo">
                                <div class="logo-shape"></div>
                            </div>
                            <div class="company-basic-info">
                                <div class="company-id" id="sidebarCompanyId">업체를 선택해주세요</div>
                                <div class="company-name" id="sidebarCompanyName">-</div>
                            </div>
                        </div>
                        <div class="company-details-table">
                            <div class="detail-row">
                                <span class="detail-label">담당자</span>
                                <span class="detail-value" id="sidebarManager">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">연락처</span>
                                <span class="detail-value" id="sidebarPhone">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">주소</span>
                                <span class="detail-value" id="sidebarAddress">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">등록일</span>
                                <span class="detail-value" id="sidebarCreatedDate">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">상태</span>
                                <span class="detail-value status-normal" id="sidebarStatus">-</span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" id="productListBtn" onclick="openMedicalServiceModalFromSidebar()">
                                <i class="fas fa-list"></i> 상품 목록
                            </button>
                            <button class="action-btn" id="reservationHistoryBtn" onclick="openReservationModalFromSidebar()">
                                <i class="fas fa-calendar-alt"></i> 예약 내역
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 의료 서비스 상세 모달 -->
    <div id="medicalServiceModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">의료 서비스 목록</h2>
                    <p class="modal-subtitle" id="modalCompanyName">업체명</p>
                </div>
                <button class="modal-close" onclick="closeMedicalServiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- 로딩 스피너 -->
                <div id="modalLoading" class="modal-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>데이터를 불러오는 중...</p>
                </div>
                
                <!-- 서비스 목록 -->
                <div id="serviceListContainer" class="service-list-container" style="display: none;">
                    <!-- 통계 카드 -->
                    <div class="service-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-briefcase-medical"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="totalServices">0</span>
                                <span class="stat-label">총 서비스</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon active">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="activeServices">0</span>
                                <span class="stat-label">활성 서비스</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon inactive">
                                <i class="fas fa-pause-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="inactiveServices">0</span>
                                <span class="stat-label">비활성 서비스</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 필터 및 검색 -->
                    <div class="service-filters">
                        <div class="filter-tabs">
                            <button class="filter-tab active" onclick="filterServices('all')">전체</button>
                            <button class="filter-tab" onclick="filterServices('active')">활성</button>
                            <button class="filter-tab" onclick="filterServices('inactive')">비활성</button>
                        </div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="serviceSearch" placeholder="서비스 검색..." onkeyup="searchServices()">
                        </div>
                    </div>
                    
                    <!-- 서비스 테이블 -->
                    <div class="service-table-wrapper">
                        <table class="service-table">
                            <thead>
                                <tr>
                                    <th>서비스 ID</th>
                                    <th>서비스명</th>
                                    <th>카테고리</th>
                                    <th>가격</th>
                                    <th>기간</th>
                                    <th>상태</th>
                                    <th>등록일</th>
                                </tr>
                            </thead>
                            <tbody id="serviceTableBody">
                                <!-- JavaScript로 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 서비스가 없을 때 -->
                    <div id="noServices" class="no-services" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>등록된 의료 서비스가 없습니다.</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeMedicalServiceModal()">닫기</button>
            </div>
        </div>
    </div>
    
    <!-- 예약내역 모달 -->
    <div id="reservationModal" class="modal-overlay">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">예약내역</h2>
                    <p class="modal-subtitle" id="reservationModalCompanyName">업체명</p>
                </div>
                <button class="modal-close" onclick="closeReservationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- 로딩 스피너 -->
                <div id="reservationLoading" class="modal-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>예약내역을 불러오는 중...</p>
                </div>
                
                <!-- 예약내역 목록 -->
                <div id="reservationListContainer" class="reservation-list-container" style="display: none;">
                    <!-- 통계 카드 -->
                    <div class="reservation-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="totalReservations">0</span>
                                <span class="stat-label">총 예약</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 예약 테이블 -->
                    <div class="reservation-table-wrapper">
                        <table class="reservation-table">
                            <thead>
                                <tr>
                                    <th>예약 ID</th>
                                    <th>고객명</th>
                                    <th>연락처</th>
                                    <th>예약일시</th>
                                    <th>서비스</th>
                                    <th>금액</th>
                                    <th>상태</th>
                                </tr>
                            </thead>
                            <tbody id="reservationTableBody">
                                <!-- JavaScript로 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 페이지네이션 -->
                    <div class="reservation-pagination" id="reservationPagination" style="display: none;">
                        <button class="btn-secondary" id="prevReservationBtn" onclick="loadReservationsPage(-1)">
                            <i class="fas fa-chevron-left"></i> 이전
                        </button>
                        <span class="page-info" id="reservationPageInfo">페이지 1 / 1</span>
                        <button class="btn-secondary" id="nextReservationBtn" onclick="loadReservationsPage(1)">
                            다음 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 예약내역이 없을 때 -->
                <div id="noReservations" class="no-reservations" style="display: none;">
                    <i class="fas fa-calendar-times"></i>
                    <p>예약된 내역이 없습니다.</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeReservationModal()">닫기</button>
            </div>
        </div>
    </div>
    
    <script src="/crm/js/admin_manage_company.js"></script>
    <script src="/crm/js/admin_manage_company_detail.js"></script>
</body>
</html>
